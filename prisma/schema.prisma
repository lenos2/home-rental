// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id                  String    @id @default(uuid())
  name                String
  slug                String    @unique
  email               String
  phone               String?
  logoUrl             String?
  website             String?
  
  // Branding & Customization
  brandColorMain      String?   @default("#3B82F6")
  brandColorAccent    String?   @default("#10B981")
  brandColorText      String?   @default("#1F2937")
  customCss           String?   @db.Text
  searchDesign        String?   @default("modern")
  backgroundType      String?   @default("default")
  backgroundColor     String?
  backgroundImage     String?
  
  // Business Details
  businessAddress     String?
  businessLicense     String?
  taxId               String?
  
  // Status
  status              String    @default("active")
  emailVerified       Boolean   @default(false)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  subscription        Subscription?
  tenantDomains       TenantDomain[]
  users               User[]
  properties          Property[]
  leases              Lease[]
  tenants             PropertyTenant[]
  offices             Office[]
  categories          PropertyCategory[]
  roles               Role[]
  auditLogs           AuditLog[]
  maintenanceRequests MaintenanceRequest[]
  payments            Payment[]
  invoices            Invoice[]
}

model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String   @unique
  tier          String?  @unique
  description   String?
  price         Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD")
  
  // Feature Flags (JSON array)
  features      Json?
  
  // Limits
  maxProperties Int      @default(10)
  maxUsers      Int      @default(5)
  maxOffices    Int      @default(1)
  
  isActive      Boolean  @default(true)
  displayOrder  Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  subscriptions Subscription[]
}

model Subscription {
  id                    String   @id @default(uuid())
  tenantId              String   @unique
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId                String
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  
  status                String
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  trialEndsAt           DateTime?
  canceledAt            DateTime?
  
  // Override Limits (for custom plans)
  maxPropertiesOverride Int?
  maxUsersOverride      Int?
  maxOfficesOverride    Int?
  
  // Payment Integration
  stripeCustomerId      String?
  stripeSubscriptionId  String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  invoices              Invoice[]
  payments              Payment[]
}

model TenantDomain {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  domain          String   @unique
  status          String
  verifiedAt      DateTime?
  sslEnabled      Boolean  @default(false)
  isPrimary       Boolean  @default(false)
  cnameTarget     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([domain])
}

model User {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email             String
  password          String
  firstName         String
  lastName          String
  phone             String?
  avatar            String?
  
  // User Type
  userType          String    @default("staff")
  
  // Role-Based Access Control
  roleId            String?
  role              Role?     @relation(fields: [roleId], references: [id])
  
  // Verification
  emailVerified     Boolean   @default(false)
  emailVerificationToken String?
  emailVerificationExpires DateTime?
  
  // Password Reset
  passwordResetToken String?
  passwordResetExpires DateTime?
  
  // Status
  status            String    @default("active")
  lastLoginAt       DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  payments          Payment[]
  maintenanceRequests MaintenanceRequest[]
  auditLogs         AuditLog[]
  
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  permissions Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  
  @@unique([tenantId, name])
}

model Property {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Information
  name              String
  description       String?  @db.Text
  propertyType      String
  
  // Category
  categoryId        String?
  category          PropertyCategory? @relation(fields: [categoryId], references: [id])
  
  // Location
  address           String
  city              String
  state             String
  zipCode           String
  country           String   @default("US")
  latitude          Decimal? @db.Decimal(10, 8)
  longitude         Decimal? @db.Decimal(11, 8)
  
  // Office Assignment
  officeId          String?
  office            Office?  @relation(fields: [officeId], references: [id])
  
  // Property Details
  bedrooms          Int?
  bathrooms         Decimal? @db.Decimal(3, 1)
  squareFeet        Int?
  lotSize           Decimal? @db.Decimal(10, 2)
  yearBuilt         Int?
  
  // Amenities & Features
  amenities         Json?
  features          Json?
  
  // Pricing
  baseRent          Decimal  @db.Decimal(10, 2)
  securityDeposit   Decimal? @db.Decimal(10, 2)
  currency          String   @default("USD")
  
  // Availability
  status            String   @default("available")
  availableFrom     DateTime?
  
  // Media
  images            Json?
  featuredImage     String?
  virtualTourUrl    String?
  
  // Utilities & Fees
  utilitiesIncluded Json?
  petPolicy         String?
  petDeposit        Decimal? @db.Decimal(10, 2)
  parkingSpaces     Int?     @default(0)
  parkingFee        Decimal? @db.Decimal(10, 2)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  leases            Lease[]
  maintenanceRequests MaintenanceRequest[]
  documents         PropertyDocument[]
  
  @@index([tenantId])
  @@index([status])
  @@index([propertyType])
}

model PropertyCategory {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  basePrice   Decimal?   @db.Decimal(10, 2)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  properties  Property[]
  
  @@unique([tenantId, name])
}

model Office {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  address     String
  city        String
  state       String
  zipCode     String
  phone       String?
  email       String?
  isPrimary   Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  properties  Property[]
  
  @@index([tenantId])
}

model PropertyTenant {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Personal Information
  firstName         String
  lastName          String
  email             String
  phone             String
  dateOfBirth       DateTime?
  
  // Emergency Contact
  emergencyContactName  String?
  emergencyContactPhone String?
  emergencyContactRelation String?
  
  // Employment
  employer          String?
  occupation        String?
  annualIncome      Decimal? @db.Decimal(12, 2)
  
  // Background Check
  backgroundCheckStatus String?
  backgroundCheckDate   DateTime?
  creditScore           Int?
  
  // Documents
  idDocument        String?
  proofOfIncome     String?
  
  status            String   @default("active")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  leases            Lease[]
  
  @@unique([tenantId, email])
  @@index([tenantId])
}

model Lease {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Lease Number
  leaseNumber       String   @unique
  
  // Property & Tenant
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id])
  propertyTenantId  String
  propertyTenant    PropertyTenant @relation(fields: [propertyTenantId], references: [id])
  
  // Additional Tenants (JSON array of tenant IDs for roommates)
  coTenants         Json?
  
  // Lease Terms
  startDate         DateTime
  endDate           DateTime
  leaseType         String
  
  // Financial Terms
  monthlyRent       Decimal  @db.Decimal(10, 2)
  securityDeposit   Decimal  @db.Decimal(10, 2)
  petDeposit        Decimal? @db.Decimal(10, 2)
  otherDeposits     Json?
  
  // Payment Schedule
  rentDueDay        Int      @default(1)
  lateFeeAmount     Decimal? @db.Decimal(10, 2)
  lateFeeDays       Int?     @default(5)
  
  // Status
  status            String   @default("pending")
  
  // Renewal
  autoRenew         Boolean  @default(false)
  renewalNoticeDate DateTime?
  
  // Termination
  terminationDate   DateTime?
  terminationReason String?
  
  // Documents
  leaseDocument     String?
  
  // Notes
  notes             String?  @db.Text
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  payments          Payment[]
  maintenanceRequests MaintenanceRequest[]
  invoices          Invoice[]
  
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
}

model MaintenanceRequest {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Request Details
  requestNumber     String   @unique
  title             String
  description       String   @db.Text
  category          String
  priority          String   @default("medium")
  
  // Property & Lease
  propertyId        String
  property          Property @relation(fields: [propertyId], references: [id])
  leaseId           String?
  lease             Lease?   @relation(fields: [leaseId], references: [id])
  
  // Requester
  requestedById     String
  requestedBy       User     @relation(fields: [requestedById], references: [id])
  
  // Assignment
  assignedTo        String?
  assignedAt        DateTime?
  
  // Status & Timeline
  status            String   @default("open")
  scheduledDate     DateTime?
  completedDate     DateTime?
  
  // Cost
  estimatedCost     Decimal? @db.Decimal(10, 2)
  actualCost        Decimal? @db.Decimal(10, 2)
  
  // Media
  images            Json?
  
  // Notes
  notes             String?  @db.Text
  resolutionNotes   String?  @db.Text
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([propertyId])
  @@index([status])
}

model Payment {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Payment Details
  paymentNumber     String   @unique
  amount            Decimal  @db.Decimal(10, 2)
  currency          String   @default("USD")
  
  // Payment Type
  paymentType       String
  
  // Related Records
  leaseId           String?
  lease             Lease?   @relation(fields: [leaseId], references: [id])
  invoiceId         String?
  invoice           Invoice? @relation(fields: [invoiceId], references: [id])
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  
  // Payment Method
  paymentMethod     String
  paymentProvider   String?
  transactionId     String?
  
  // Status
  status            String   @default("pending")
  paidAt            DateTime?
  
  // Payer
  paidById          String?
  paidBy            User?    @relation(fields: [paidById], references: [id])
  payerName         String?
  payerEmail        String?
  
  // Notes
  notes             String?  @db.Text
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([leaseId])
  @@index([status])
}

model Invoice {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Invoice Details
  invoiceNumber     String   @unique
  
  // Related Records
  leaseId           String?
  lease             Lease?   @relation(fields: [leaseId], references: [id])
  subscriptionId    String?
  subscription      Subscription? @relation(fields: [subscriptionId], references: [id])
  
  // Financial Details
  subtotal          Decimal  @db.Decimal(10, 2)
  tax               Decimal  @db.Decimal(10, 2) @default(0)
  total             Decimal  @db.Decimal(10, 2)
  currency          String   @default("USD")
  
  // Line Items (JSON array)
  items             Json
  
  // Dates
  issueDate         DateTime @default(now())
  dueDate           DateTime
  paidDate          DateTime?
  
  // Status
  status            String   @default("pending")
  
  // Notes
  notes             String?  @db.Text
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  payments          Payment[]
  
  @@index([tenantId])
  @@index([status])
}

model PropertyDocument {
  id          String   @id @default(uuid())
  tenantId    String
  propertyId  String
  property    Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  name        String
  type        String
  fileUrl     String
  fileSize    Int?
  mimeType    String?
  
  uploadedBy  String?
  uploadedAt  DateTime @default(now())
  
  @@index([propertyId])
}

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  action      String
  resource    String
  resourceId  String?
  
  changes     Json?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([resource])
}
